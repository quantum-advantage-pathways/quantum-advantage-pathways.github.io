name: Validate Submission

on:
  issues:
    types: [opened, edited]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to validate'
        required: true
        type: number

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Pathway Assignment
        uses: actions/github-script@v7
        with:
          script: |
            // Get issue data - either from event or manual input
            let issue;
            if (context.payload.issue) {
              issue = context.payload.issue;
            } else if (context.payload.inputs && context.payload.inputs.issue_number) {
              const issueData = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(context.payload.inputs.issue_number)
              });
              issue = issueData.data;
            } else {
              console.log('No issue found, exiting');
              return;
            }

            const issueBody = issue.body || '';
            const labels = issue.labels.map(l => l.name);

            // Check if this is a submission issue
            if (!labels.includes('submission')) {
              console.log('Not a submission issue, skipping validation');
              return;
            }

            // Parse issue body to detect which path submission checkbox is checked
            let detectedPath = null;
            let pathSubmissionLabel = null;

            // Look for checked "Path N submission" in the issue body
            const path1Match = issueBody.match(/- \[x\] Path 1 submission/i);
            const path2Match = issueBody.match(/- \[x\] Path 2 submission/i);
            const path3Match = issueBody.match(/- \[x\] Path 3 submission/i);

            if (path1Match) {
              detectedPath = 1;
              pathSubmissionLabel = 'Path 1 submission';
            } else if (path2Match) {
              detectedPath = 2;
              pathSubmissionLabel = 'Path 2 submission';
            } else if (path3Match) {
              detectedPath = 3;
              pathSubmissionLabel = 'Path 3 submission';
            }

            if (!detectedPath) {
              console.log('No path checkbox detected, checking labels as fallback');

              // Fallback to label-based detection
              if (labels.includes('pathway: observable-estimations')) {
                detectedPath = 1;
                pathSubmissionLabel = 'Path 1 submission';
              } else if (labels.includes('pathway: variational-problems')) {
                detectedPath = 2;
                pathSubmissionLabel = 'Path 2 submission';
              } else if (labels.includes('pathway: classically-verifiable')) {
                detectedPath = 3;
                pathSubmissionLabel = 'Path 3 submission';
              }
            }

            if (!pathSubmissionLabel) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '⚠️ **Validation Warning**: Could not detect pathway. Please ensure:\n\n1. You checked the "Path N submission" checkbox in the issue\n2. You used one of the official issue templates:\n   - 📊 Path 1 - Observable Estimations Submission\n   - ⚛️ Path 2 - Variational Problems Submission\n   - ✅ Path 3 - Classically Verifiable Problems Submission'
              });
              return;
            }

            console.log(`Detected: ${pathSubmissionLabel}`);

            // Apply the path submission label if not already present
            if (!labels.includes(pathSubmissionLabel)) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: [pathSubmissionLabel]
              });
              console.log(`Applied label: ${pathSubmissionLabel}`);
            } else {
              console.log(`Label already exists: ${pathSubmissionLabel}`);
            }

            // Determine pathway directory based on detected path
            const pathwayMapping = {
              1: 'observable_estimations',
              2: 'variational_problems',
              3: 'classically_verifiable'
            };

            const pathway = pathwayMapping[detectedPath];

            // Extract Circuit ID from the issue body
            const circuitMatch = issueBody.match(/### Circuit\s*\n\s*(.+)/i);
            const circuitId = circuitMatch ? circuitMatch[1].trim() : null;

            if (!circuitId) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '⚠️ **Validation Warning**: Circuit ID is missing from the submission. Please fill in all required fields.'
              });
              return;
            }

            // Check if circuit exists in the correct pathway
            const fs = require('fs');
            const path = require('path');

            const circuitPaths = [
              `problems/${pathway}/${circuitId}.qasm`,
              `problems/${pathway}/${circuitId}.json`
            ];

            let circuitExists = false;
            for (const circuitPath of circuitPaths) {
              if (fs.existsSync(circuitPath)) {
                circuitExists = true;
                break;
              }
            }

            // Check in data directory as well
            const dataPath = `data/paths/${pathway}/problems.json`;
            if (fs.existsSync(dataPath)) {
              const problemsData = JSON.parse(fs.readFileSync(dataPath, 'utf8'));
              const problemExists = problemsData.some(p => p.id === circuitId || p.name === circuitId);
              if (problemExists) {
                circuitExists = true;
              }
            }

            const pathwayNames = {
              'observable_estimations': '📊 Observable Estimations',
              'variational_problems': '⚛️ Variational Problems',
              'classically_verifiable': '✅ Classically Verifiable Problems'
            };

            if (circuitExists) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `✅ **Validation Success**\n\n**Detected Path:** ${pathSubmissionLabel} ✓\n**Circuit:** \`${circuitId}\` exists in the repository ✓\n\n**Applied Labels:**\n- \`${pathSubmissionLabel}\` (detected from checkbox)\n- \`validated\`\n\n**Next Steps:**\n1. Maintainers will review your submission for reproducibility and compliance with validation criteria\n2. Ensure all required fields are filled out\n3. Provide links to papers/code for method verification\n\nThank you for your contribution! 🚀`
              });

              // Add verified label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['validated']
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `⚠️ **Validation Warning**\n\n**Detected Path:** ${pathSubmissionLabel} ✓\n**Circuit:** \`${circuitId}\` not found ⚠️\n\n**Applied Labels:**\n- \`${pathSubmissionLabel}\` (detected from checkbox)\n- \`needs-review\`\n\n**Possible Issues:**\n- The circuit ID might be misspelled\n- The circuit might not exist in \`problems/${pathway}/\` directory\n- You may be submitting to the wrong pathway\n\n**What to do:**\n1. Verify the circuit ID is correct\n2. Check the available circuits at: https://quantum-advantage-pathways.github.io/\n3. If this is a new problem, you may need to add the circuit definition first\n4. Ensure you selected the correct pathway template`
              });

              // Add needs-review label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['needs-review']
              });
            }

      - name: Validate Required Fields
        uses: actions/github-script@v7
        with:
          script: |
            // Get issue data - either from event or manual input
            let issue;
            if (context.payload.issue) {
              issue = context.payload.issue;
            } else if (context.payload.inputs && context.payload.inputs.issue_number) {
              const issueData = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(context.payload.inputs.issue_number)
              });
              issue = issueData.data;
            } else {
              console.log('No issue found, exiting');
              return;
            }

            const issueBody = issue.body || '';
            const labels = issue.labels.map(l => l.name);

            // Check if this is a submission issue
            if (!labels.includes('submission')) {
              console.log('Not a submission issue, skipping validation');
              return;
            }

            // Check for required fields based on pathway
            const requiredFields = [
              'Circuit',
              'Method',
              'Institution',
              'Quantum Time',
              'Quantum Hardware',
              'Submission Date'
            ];

            const missingFields = [];
            for (const field of requiredFields) {
              const regex = new RegExp(`### ${field}\\s*\\n\\s*(.+)`, 'i');
              const match = issueBody.match(regex);
              if (!match || match[1].trim() === '' || match[1].includes('_No response_')) {
                missingFields.push(field);
              }
            }

            if (missingFields.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `⚠️ **Missing Required Fields**: The following required fields are incomplete:\n\n${missingFields.map(f => `- ${f}`).join('\n')}\n\nPlease edit the issue to complete all required fields.`
              });

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['incomplete']
              });
            }
